# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

# Begin: OpenLDAP Server Template
function openldap_server_install () {
  log_info "Configuring OpenLDAP Server"
  pushd ${SOCA_BOOTSTRAP_ASSETS_FOLDER}

  {% if context.get("/configuration/BaseOS") in ("ubuntu2204", "ubuntu2404") %}
    # Debian Based Distro
    if ! verify_package_installed slapd; then
      log_info "slapd not installed, installing it "
      packages_install slapd
    fi

    if ! verify_package_installed ldap-utils; then
      log_info "slapd not installed, installing it "
      packages_install ldap-utils
    fi
  {% else %}
    # RedHat based Distro (up to RHEL8)
    if ! verify_package_installed openldap-servers; then
      packages_install openldap-servers
    fi
  {% endif %}

  systemctl enable slapd
  if ! systemctl start slapd; then
    log_error "Unable to start slapd"
  else
    log_info "Successfully started slapd"
  fi

  local OPENLDAP_SERVICE_ACCOUNT_SECRET=$(get_secret "{{ context.get("/configuration/UserDirectory/service_account_secret_arn") }}")
  local SOCA_LDAP_DOMAIN_NAME="{{ context.get("/configuration/UserDirectory/domain_name") }}"
  local SOCA_LDAP_BASE="{{ context.get("/configuration/UserDirectory/domain_base") }}"
  local SOCA_LDAP_ENDPOINT="{{ context.get("/configuration/UserDirectory/endpoint") }}"
  local SOCA_LDAP_PEOPLE_SEARCH_BASE="{{ context.get("/configuration/UserDirectory/people_search_base") | lower }}"
  local SOCA_LDAP_GROUP_SEARCH_BASE="{{ context.get("/configuration/UserDirectory/group_search_base") | lower }}"
  local SOCA_LDAP_ADMINS_SEARCH_BASE="{{ context.get("/configuration/UserDirectory/admins_search_base") | lower }}"

  local SOCA_LDAP_PEOPLE_OU_NAME=$(echo ${SOCA_LDAP_PEOPLE_SEARCH_BASE} | awk -F'[,=]' '{print $2}')
  local SOCA_LDAP_GROUP_OU_NAME=$(echo ${SOCA_LDAP_GROUP_SEARCH_BASE} | awk -F'[,=]' '{print $2}')
  local SOCA_LDAP_ADMIN_OU_NAME=$(echo ${SOCA_LDAP_ADMINS_SEARCH_BASE} | awk -F'[,=]' '{print $2}')

  local SOCA_LDAP_BASE_NAME=$(echo ${SOCA_LDAP_BASE} | awk -F'[,=]' '{print $2}')
  local ADMIN_LDAP_SERVICE_ACCOUNT_DN=$(echo ${OPENLDAP_SERVICE_ACCOUNT_SECRET} | jq -r ". | fromjson.username")
  local ADMIN_LDAP_SERVICE_ACCOUNT_NAME=$(echo ${ADMIN_LDAP_SERVICE_ACCOUNT_DN} | awk -F'[,=]' '{print $2}')

  local ADMIN_LDAP_SERVICE_ACCOUNT_PASSWORD=$(echo ${OPENLDAP_SERVICE_ACCOUNT_SECRET} | jq -r ". | fromjson.password")
  local ADMIN_LDAP_SERVICE_ACCOUNT_PASSWORD_ENCRYPTED=$(/sbin/slappasswd -s "${ADMIN_LDAP_SERVICE_ACCOUNT_PASSWORD}" -h "{SSHA}")

  local OPENLDAP_PATH_PREFIX
  {% if context.get("/configuration/BaseOS") in ("ubuntu2204", "ubuntu2404") %}
    OPENLDAP_PATH_PREFIX="/etc/ldap"
  {% else %}
    OPENLDAP_PATH_PREFIX="/etc/openldap"
  {% endif %}

  log_info "Detected OpenLDAP path prefix: ${OPENLDAP_PATH_PREFIX}"

  # Note: you can disable ldap:/// by removing the entry below
  log_info "Preparing ldaps:// listener"
  {% if context.get("/configuration/BaseOS") in ("amazonlinux2023") %}
    log_info "No SLAPD_SERVICES updates needed on AmazonLinux 2023, services ldap:/// ldapi:/// ldaps:/// managed via /usr/lib/systemd/system/slapd.service"
  
  {% elif context.get("/configuration/BaseOS") in ("ubuntu2204", "ubuntu2404") %}
     ATTEMPT=1
     while [[ ${ATTEMPT} -le 5 ]]; do
        if cp /etc/default/slapd /etc/default/slapd.soca.backup; then
            break
        else
            log_warning "Unable to access to /etc/default/slapd. Retrying in 15 seconds..."
            sleep 15
            if [[ ${ATTEMPT} == 5 ]]; then
              exit_fail "OpenLDAP - Unable to copy /etc/default/slapd"
            fi
            ${ATTEMPT}=$((attempt + 1))
          fi
     done
     sed -i '/^[[:space:]]*SLAPD_SERVICES=/d' /etc/default/slapd
     echo """SLAPD_SERVICES=\"ldap:/// ldapi:/// ldaps:///\"""" >> /etc/default/slapd

  {% else %}
     ATTEMPT=1
     while [[ ${ATTEMPT} -le 5 ]]; do
        if cp /etc/sysconfig/slapd /etc/sysconfig/slapd.soca.backup; then
           break
        else
            log_warning "Unable to access toetc/sysconfig/slapd. Retrying in 15 seconds..."
            sleep 15
            if [[ ${ATTEMPT} == 5 ]]; then
              exit_fail "OpenLDAP - Unable to copy etc/sysconfig/slapd"
            fi
            ${ATTEMPT}=$((attempt + 1))
          fi
     done
     sed -i '/^[[:space:]]*SLAPD_URLS=/d' /etc/sysconfig/slapd
     echo """SLAPD_URLS="ldapi:/// ldap:/// ldaps:///"""" >> /etc/sysconfig/slapd
  {% endif %}

  log_info "Generate 10y certificate for LDAPs"
  mkdir -p ${OPENLDAP_PATH_PREFIX}/certs/

  openssl req -new -newkey rsa:2048 -days 3650 -nodes -x509 \
      -subj "/CN=${SOCA_LDAP_DOMAIN_NAME}" \
      -keyout ${OPENLDAP_PATH_PREFIX}/certs/soca.key -out ${OPENLDAP_PATH_PREFIX}/certs/soca.crt

  {% if context.get("/configuration/BaseOS") in ("ubuntu2204", "ubuntu2404") %}
    chown openldap:openldap ${OPENLDAP_PATH_PREFIX}/certs/soca.key ${OPENLDAP_PATH_PREFIX}/certs/soca.crt
    chmod 600 ${OPENLDAP_PATH_PREFIX}/certs/soca.key ${OPENLDAP_PATH_PREFIX}/certs/soca.crt
  {% else %}
    chown ldap:ldap ${OPENLDAP_PATH_PREFIX}/certs/soca.key ${OPENLDAP_PATH_PREFIX}/certs/soca.crt
    chmod 600 ${OPENLDAP_PATH_PREFIX}/certs/soca.key ${OPENLDAP_PATH_PREFIX}/certs/soca.crt
  {% endif %}

  {% if context.get("/configuration/BaseOS") in ("amazonlinux2023", "amazonlinux2","centos7", "rhel7", "rhel8", "rhel9", "rocky8", "rocky9")  %}
      log_info "Adding OpenLDAP self-signed certificate to system CA trust store"
      cp ${OPENLDAP_PATH_PREFIX}/certs/soca.crt /etc/pki/ca-trust/source/anchors/
      log_info "Updating system CA Trust Store"
      update-ca-trust
  {% endif %}

  # Determine whether openldap is using  Hierarchical DB (hdb) - old distro < RHEL8 - or Memory-Mapped DB (mdb), default for new distro
  local OPEN_LDAP_CONFIG_KEY
  OPEN_LDAP_CONFIG_KEY=$(ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=config "(objectClass=olcMdbConfig)" dn | grep ^dn: | awk '{print $2}')
  if [[ -z "${OPEN_LDAP_CONFIG_KEY}" ]]; then
    OPEN_LDAP_CONFIG_KEY=$(ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=config "(objectClass=olcHdbConfig)" dn | grep ^dn: | awk '{print $2}')
  fi

  log_info "OPEN_LDAP_CONFIG_KEY is ${OPEN_LDAP_CONFIG_KEY}"

  echo -e "
dn: ${OPEN_LDAP_CONFIG_KEY}
changetype: modify
replace: olcSuffix
olcSuffix: ${SOCA_LDAP_BASE}

dn: ${OPEN_LDAP_CONFIG_KEY}
changetype: modify
replace: olcRootDN
olcRootDN: ${ADMIN_LDAP_SERVICE_ACCOUNT_DN}

dn: ${OPEN_LDAP_CONFIG_KEY}
changetype: modify
replace: olcRootPW
olcRootPW: ${ADMIN_LDAP_SERVICE_ACCOUNT_PASSWORD_ENCRYPTED}" > db.ldif

  echo -e "
dn: cn=config
changetype: modify
replace: olcTLSCertificateFile
olcTLSCertificateFile: ${OPENLDAP_PATH_PREFIX}/certs/soca.crt
-
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: ${OPENLDAP_PATH_PREFIX}/certs/soca.key
-
replace: olcTLSCACertificateFile
olcTLSCACertificateFile: ${OPENLDAP_PATH_PREFIX}/certs/soca.crt" > add_tls.ldif

  echo -e "
dn: ${OPEN_LDAP_CONFIG_KEY}
changetype: modify
replace: olcAccess
olcAccess: {0}to attrs=userPassword by self write by anonymous auth by group.exact="ou=admins,${SOCA_LDAP_BASE}" write by * none
-
add: olcAccess
olcAccess: {1}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" write by dn.base="${SOCA_LDAP_BASE}" write by * read" > change_user_password.ldif

  echo -e "
dn: cn=sudo,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: sudo
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.1 NAME 'sudoUser' DESC 'User(s) who may  run sudo' EQUALITY caseExactIA5Match SUBSTR caseExactIA5SubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.2 NAME 'sudoHost' DESC 'Host(s) who may run sudo' EQUALITY caseExactIA5Match SUBSTR caseExactIA5SubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.3 NAME 'sudoCommand' DESC 'Command(s) to be executed by sudo' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.4 NAME 'sudoRunAs' DESC 'User(s) impersonated by sudo (deprecated)' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.5 NAME 'sudoOption' DESC 'Options(s) followed by sudo' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.6 NAME 'sudoRunAsUser' DESC 'User(s) impersonated by sudo' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.7 NAME 'sudoRunAsGroup' DESC 'Group(s) impersonated by sudo' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcObjectClasses: ( 1.3.6.1.4.1.15953.9.2.1 NAME 'sudoRole' SUP top STRUCTURAL DESC 'Sudoer Entries' MUST ( cn ) MAY ( sudoUser $ sudoHost $ sudoCommand $ sudoRunAs $ sudoRunAsUser $ sudoRunAsGroup $ sudoOption $ description ) )" > sudoers.ldif

  /bin/ldapmodify -Y EXTERNAL -H ldapi:/// -f db.ldif
  /bin/ldapmodify -Y EXTERNAL -H ldapi:/// -f add_tls.ldif
  /bin/ldapmodify -Y EXTERNAL -H ldapi:/// -f change_user_password.ldif
  /bin/ldapadd -Y EXTERNAL -H ldapi:/// -f sudoers.ldif

  if ! ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=schema,cn=config -LLL cn | grep -E "cn: \{?[0-9]*\}?cosine"; then
    log_info "${OPENLDAP_PATH_PREFIX}/schema/cosine.ldif schema not found on openldap, adding it"
    /bin/ldapadd -Y EXTERNAL -H ldapi:/// -f ${OPENLDAP_PATH_PREFIX}/schema/cosine.ldif
  else
    log_info "${OPENLDAP_PATH_PREFIX}/schema/cosine.ldif schema already there, skipping"
  fi

  if ! ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=schema,cn=config -LLL cn | grep -E "cn: \{?[0-9]*\}?nis"; then
    log_info "${OPENLDAP_PATH_PREFIX}/schema/nis.ldif schema not found on openldap, adding it"
    /bin/ldapadd -Y EXTERNAL -H ldapi:/// -f ${OPENLDAP_PATH_PREFIX}/schema/nis.ldif
  else
    log_info "${OPENLDAP_PATH_PREFIX}/schema/nis.ldif schema already there, skipping"
  fi

  if ! ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=schema,cn=config -LLL cn | grep -E "cn: \{?[0-9]*\}?inetorgperson"; then
    log_info "${OPENLDAP_PATH_PREFIX}/schema/inetorgperson.ldif schema not found on openldap, adding it"
    /bin/ldapadd -Y EXTERNAL -H ldapi:/// -f ${OPENLDAP_PATH_PREFIX}/schema/inetorgperson.ldif
  else
    log_info "${OPENLDAP_PATH_PREFIX}/schema/inetorgperson.ldif schema already there, skipping"
  fi

  log_info "Creating SOCA OpenLDAP base"
  echo -e "
# Root Entry
dn: ${SOCA_LDAP_BASE}
dc: ${SOCA_LDAP_BASE_NAME}
objectClass: top
objectClass: domain

# Admin Entry
dn: ${ADMIN_LDAP_SERVICE_ACCOUNT_DN}
objectClass: organizationalRole
cn: ${ADMIN_LDAP_SERVICE_ACCOUNT_NAME}
description: LDAP Manager

# People OU
dn: ${SOCA_LDAP_PEOPLE_SEARCH_BASE}
objectClass: organizationalUnit
ou: ${SOCA_LDAP_PEOPLE_OU_NAME}

# Group OU
dn: ${SOCA_LDAP_GROUP_SEARCH_BASE}
objectClass: organizationalUnit
ou: ${SOCA_LDAP_GROUP_OU_NAME}

# Sudoers OU
dn: ${SOCA_LDAP_ADMINS_SEARCH_BASE}
objectClass: organizationalUnit
ou: ${SOCA_LDAP_ADMIN_OU_NAME}
"> base.ldif

  /bin/ldapadd -x -w "${ADMIN_LDAP_SERVICE_ACCOUNT_PASSWORD}" -D "${ADMIN_LDAP_SERVICE_ACCOUNT_DN}" -f base.ldif

  log_info "Performing Authconfig adjustments"
  {% if context.get("/configuration/BaseOS") in ("centos7", "rhel7", "amazonlinux2")  %}
    authconfig --disablesssd \
      --disablesssdauth \
      --disableldap \
      --disableldapauth \
      --disablekrb5 \
      --disablekrb5kdcdns \
      --disablekrb5realmdns \
      --disablewinbind \
      --disablewinbindauth \
      --disablewinbindkrb5 \
      --disableldaptls \
      --disablerfc2307bis \
      --updateall
    sss_cache -E
    authconfig --enablesssd \
      --enablesssdauth \
      --enableldap \
      --enableldaptls \
      --enableldapauth \
      --ldapserver="${SOCA_LDAP_ENDPOINT}" \
      --ldapbasedn="${SOCA_LDAP_BASE}" \
      --enablelocauthorize \
      --enablemkhomedir \
      --enablecachecreds \
      --updateall
  {% else %}
    # It doesn't seem like authselect is necessary on Ubuntu
    # If it is, TODO: Install authselect from source
 
    # authselect is authconfig replacement for newer distro
    # mkdir -p /etc/authselect
    # authselect select sssd with-mkhomedir --force
  {% endif %}

  echo "sudoers: files sss" >> /etc/nsswitch.conf

  ## Configure SSSD
  echo -e "[domain/default]
enumerate = True
autofs_provider = ldap
cache_credentials = True
ldap_search_base = ${SOCA_LDAP_BASE}
id_provider = ldap
auth_provider = ldap
chpass_provider = ldap
sudo_provider = ldap
ldap_tls_reqcert = never
ldap_sudo_search_base = ${SOCA_LDAP_ADMIN_SEARCH_BASE}
ldap_uri = ${SOCA_LDAP_ENDPOINT}
ldap_id_use_start_tls = True
use_fully_qualified_names = False
ldap_tls_cacertdir = ${OPENLDAP_PATH_PREFIX}/certs/
ldap_sudo_full_refresh_interval=86400
ldap_sudo_smart_refresh_interval=3600

[sssd]
services = nss, pam, autofs, sudo
full_name_format = %2\$s\%1\$s
domains = default

[nss]
homedir_substring = /data/home

[pam]

[sudo]


[autofs]

[ssh]

[pac]

[ifp]

[secrets]" > /etc/sssd/sssd.conf
  chmod 600 /etc/sssd/sssd.conf

  log_info "Disable TLS Cert Checking enforcement to allow self-signed certificate"
  sed -i '/^[[:space:]]*TLS_REQCERT/d' ${OPENLDAP_PATH_PREFIX}/ldap.conf
  cp ${OPENLDAP_PATH_PREFIX}/ldap.conf ${OPENLDAP_PATH_PREFIX}/ldap.conf.soca.backup
  echo "TLS_REQCERT never" >> ${OPENLDAP_PATH_PREFIX}/ldap.conf

  log_info "Enabling and Restarting sssd/slapd"
  systemctl enable sssd
  systemctl enable slapd
  systemctl stop sssd
  systemctl stop slapd
  sleep 5
  if ! systemctl start slapd; then
    exit_fail "Unable to start OpenLDAP"
  fi

  if ! systemctl start sssd; then
    exit_fail "Unable to start sssd"
  fi 

  popd
}
openldap_server_install
# End: OpenLDAP Server Template
