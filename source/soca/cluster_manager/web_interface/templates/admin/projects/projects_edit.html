<!--
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
-->

<!DOCTYPE html>
<html lang="en">

<head>
    {% include 'common/header.html' %}
</head>
<body id="page-top">
<div id="wrapper">
    {% include 'common/vertical_menu_bar.html' %}
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <br>
            <div class="container-fluid">
                {% include 'common/horizontal_menu_bar.html' %}
                {% include 'common/flashed_messages.html' %}

                <div class="col-md-12">
                    <div class="tab-content" id="nav-tabContent">
                        <div class="tab-pane fade show active" id="nav-add" role="tabpanel"
                             aria-labelledby="nav-home-tab">
                            <br>
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Edit SOCA Project</h6>
                                </div>
                                    <div class="card-body">
                                        <form action="/admin/projects/edit/update" method="post">

                                            <div class="form-group row">
                                                <label for="project_name" class="col-md-2 col-form-label" data-toggle="tooltip" data-placement="top" title="Name for your project">
                                                    Project Name
                                                </label>
                                                <div class="col-md-10">
                                                    <input id="project_name" placeholder="Friendly Name for your project"
                                                       class="form-control"
                                                       type="text"
                                                       disabled value="{{project_info.project_name}}" name="project_name">
                                                </div>
                                            </div>

                                            <div class="form-group row">
                                                <label for="aws_budget" class="col-md-2 col-form-label" data-toggle="tooltip" data-placement="top" title="Control AWS resource deployment authorization via AWS Budget">
                                                  Associated AWS Budget
                                                </label>
                                                <div class="col-md-10">
                                                  <select class="form-control" id="aws_budget" name="aws_budget">
                                                     {% if not project_info.aws_budget %}
                                                     <option value="" selected > No Budget</option>
                                                     {% endif %}

                                                     {% for budget_name in budgets %}
                                                         {% if budget_name == project_info.aws_budget %}
                                                            <option value="{{ budget_name }}" selected> {{budget_name}}</option>
                                                         {% else %}
                                                          <option value="{{ budget_name }}"> {{budget_name}}</option>
                                                         {% endif %}
                                                     {% endfor %}
                                                    </select>
                                                </div>
                                            </div>


                                            <div class="form-group row">
                                                <label for="description" class="col-md-2 col-form-label" data-toggle="tooltip" data-placement="top" title="Description of your Project">
                                                  Description
                                                </label>
                                                <div class="col-md-10">
                                                     <textarea id="description" placeholder="(Optional) Description for your project maximum 500 characters."
                                                          class="form-control" rows="3"  name="description">{{project_info.description}}</textarea>
                                                </div>
                                            </div>


                                            <!-- User/Group ACL -->
                                          <div class="form-group row">
                                            <label for="project_name" class="col-md-2 col-form-label" data-toggle="tooltip" data-placement="top" title="List of allowed/denied users or group">
                                              Users/Groups Permissions
                                            </label>
                                            <div class="col-md-10">
                                              <nav>
                                                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                                                  <a class="nav-item nav-link active" id="nav-home-tab" data-bs-toggle="tab" href="#users"
                                                    role="tab" aria-controls="nav-home" aria-selected="true">Users Permissions</a>
                                                  <a class="nav-item nav-link" id="nav-profile-tab" data-bs-toggle="tab" href="#groups"
                                                    role="tab" aria-controls="nav-delete" aria-selected="false">Groups Permissions</a>
                                                </div>
                                              </nav>

                                              <!-- Tab Content -->
                                              <div class="tab-content" id="accessControlContent">
                                                <br>

                                                <!-- USERS TAB -->
                                                <div class="tab-pane fade show active" id="users" role="tabpanel">

                                                  <!-- Allowed Users -->
                                                  <div class="form-group mb-3">
                                                    <label for="allowed_users" data-bs-toggle="tooltip" title="List of allowed users">
                                                      <strong>Allowed Users</strong>
                                                    </label>
                                                    <div class="row g-2 align-items-center">
                                                      <div class="col-md-3">
                                                        <div class="input-group">
                                                          <select class="form-control" id="user_select">
                                                            <option value="*">All users</option>
                                                            {% for user in all_users %}
                                                            <option value="{{ user }}">{{ user }}</option>
                                                            {% endfor %}
                                                          </select>
                                                          <button class="btn btn-primary" type="button" id="add_user_btn">Add</button>
                                                        </div>
                                                      </div>
                                                      <div class="col-md-9">
                                                        <input id="allowed_users" class="form-control" name="allowed_users" value="{{project_info.allowed_users}}" data-ub-tag-variant="primary">
                                                      </div>
                                                    </div>
                                                    <small>
                                                      <ul>
                                                        <li>Must be a valid SOCA user</li>
                                                        <li>Use <code>*</code> to allow all users</li>
                                                        <li>Leave blank to remove access</li>
                                                      </ul>
                                                    </small>
                                                  </div>

                                                  <!-- Denied Users -->
                                                  <div class="form-group mb-3">
                                                    <label for="denied_users" data-bs-toggle="tooltip" title="List of denied users">
                                                      <strong>Denied Users</strong>
                                                    </label>
                                                    <input id="denied_users" class="form-control mb-2" name="denied_users" data-ub-tag-variant="primary" value="{{project_info.denied_users}}">                
                                                  </div>
                                                  <small>
                                                      <ul>
                                                        <li>Must be a valid SOCA user</li>
                                                        <li>Use <code>*</code> to deny all</li>
                                                        <li>Deny takes precedence over allow</li>
                                                      </ul>
                                                    </small>
                                                </div>

                                                <!-- GROUPS TAB -->
                                                <div class="tab-pane fade" id="groups" role="tabpanel">

                                                  <!-- Allowed Groups -->
                                                  <div class="form-group mb-3">
                                                    <label for="allowed_groups" data-bs-toggle="tooltip" title="List of allowed groups">
                                                      <strong>Allowed Groups</strong>
                                                    </label>
                                                    <div class="row g-2 align-items-center">
                                                      <div class="col-md-3">
                                                        <div class="input-group">
                                                          <select class="form-control" id="group_select">
                                                            {% for group in all_groups %}
                                                            <option value="{{ group }}">{{ group }}</option>
                                                            {% endfor %}
                                                          </select>
                                                          <button class="btn btn-primary" type="button" id="add_group_btn">Add</button>
                                                        </div>
                                                      </div>
                                                      <div class="col-md-9">
                                                        <input id="allowed_groups" class="form-control" name="allowed_groups" data-ub-tag-variant="primary" value="{{project_info.allowed_groups}}">
                                                      </div>
                                                    </div>
                                                    <small>
                                                      <ul>
                                                        <li>Must be a valid SOCA group</li>
                                                      </ul>
                                                    </small>
                                                  </div>

                                                  <!-- Denied Groups -->
                                                  <div class="form-group mb-3">
                                                    <label for="denied_groups" data-bs-toggle="tooltip" title="List of denied groups">
                                                      <strong>Denied Groups</strong>
                                                    </label>
                                                    <input id="denied_groups" class="form-control mb-2" name="denied_groups" data-ub-tag-variant="primary" value="{{project_info.denied_groups}}">
                                                    <small>
                                                      <ul>
                                                        <li>Must be a valid SOCA group</li>
                                                        <li>Deny takes precedence over allow</li>
                                                        <li>Users in denied groups will be denied even if individually allowed</li>
                                                      </ul>
                                                    </small>
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                          </div>


                                          

                                            <!-- Virtual Desktop Stacks -->
                                            <div class="form-group row">
                                                <label for="software_stack_ids" class="col-md-2 col-form-label" data-toggle="tooltip" data-placement="top" title="List of authorized Virtual Desktop Software Stacks">
                                                  Authorized <a target="_blank" href="/admin/virtual_desktops/software_stacks">Virtual Desktop Stacks</a>
                                                </label>
                                                <div class="col-md-10">
                                                  <div class="alert alert-warning" id="numberOfSelectedStacks"></div>
                                                  <button class="btn btn-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#softwareStackSelect">
                                                    View/Manage Authorized Virtual Desktops Stacks
                                                  </button>
                                                  <div class="collapse" id="softwareStackSelect">
                                                    <select class="form-control" style="height: 500px;" id="software_stack_ids" name="software_stack_ids" multiple>
                                                            {% for software_stack_id, software_stack_info in software_stacks.items() %}
                                                                 {% if software_stack_info.id in project_info.software_stack_ids %}
                                                                    <option selected value="{{ software_stack_id }}">
                                                                            ID: {{software_stack_id}} - {{ software_stack_info.stack_name }} ({{software_stack_info.ami_arch}})
                                                                    </option>
                                                                 {% else %}
                                                                    <option value="{{ software_stack_id }}">
                                                                            ID: {{software_stack_id}} - {{ software_stack_info.stack_name }} ({{software_stack_info.ami_arch}})
                                                                    </option>
                                                                 {% endif %}
                                                            {% endfor %}
                                                        </select>
                                                  </div>
                                                </div>
                                            </div>


                                            <!-- Target Node Stacks -->
                                            <div class="form-group row">
                                                <label for="target_nodes_software_stack_ids" class="col-md-2 col-form-label" data-toggle="tooltip" data-placement="top" title="List of authorized Target node stacks">
                                                  Authorized <a target="_blank" href="/admin/target_nodes/software_stacks">Target Node Stacks</a>
                                                </label>
                                                <div class="col-md-10">
                                                  <div class="alert alert-warning" id="numberOfSelectedTargetNodeStacks"></div>
                                                  <button class="btn btn-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#targetNodeSoftwareStackSelect">
                                                    View/Manage Authorized Target Nodes Stacks
                                                  </button>
                                                  <div class="collapse" id="targetNodeSoftwareStackSelect">
                                                    <select class="form-control" style="height: 500px;" id="target_nodes_software_stack_ids" name="target_nodes_software_stack_ids" multiple>
                                                        {% for software_stack_id, software_stack_info in target_nodes_software_stacks.items() %}
                                                            {% if software_stack_info.id in project_info.target_node_software_stack_ids %}
                                                                <option selected value="{{ software_stack_id }}">
                                                                        ID: {{software_stack_id}} - {{ software_stack_info.stack_name }} ({{software_stack_info.ami_arch}})
                                                                </option>
                                                             {% else %}
                                                                <option value="{{ software_stack_id }}">
                                                                        ID: {{software_stack_id}} - {{ software_stack_info.stack_name }} ({{software_stack_info.ami_arch}})
                                                                </option>
                                                             {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                  </div>
                                                </div>
                                            </div>

                                            <!-- Application Profiles -->
                                          <div class="form-group row">
                                            <label for="application_profile_ids" class="col-md-2 col-form-label" data-toggle="tooltip" data-placement="top" title="List of authorized Application Profiles">
                                              Authorized <a target="_blank" href="/admin/applications">Application Profiles</a>
                                            </label>
                                            <div class="col-md-10">
                                              <div class="alert alert-warning" id="numberOfSelectedApplicationProfiles"></div>
                                              <button class="btn btn-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#ApplicationProfileSelect">
                                                View/Manage Authorized Application Profiles
                                              </button>
                                              <div class="collapse" id="ApplicationProfileSelect">
                                                <select class="form-control" style="height: 500px;" id="application_profile_ids" name="application_profile_ids" multiple>
                                                  {% for application_id, application_data in application_profiles.items() %}
                                                    {% if application_data.id in project_info.application_profile_ids %}
                                                    <option selected value="{{ application_id }}">
                                                        ID: {{application_id}} - {{ application_data.profile_name }}
                                                    </option>
                                                    {% else %}
                                                    <option value="{{ application_id }}">
                                                        ID: {{application_id}} - {{ application_data.profile_name }}
                                                    </option>
                                                    {% endif %}

                                                    {% endfor %}
                                                </select>
                                              </div>
                                            </div>
                                          </div>

                                            <div class="form-group row">
                                            <div class="col-md-9 offset-md-3">
                                              <input type="hidden" name="project_id" value="{{project_info.id}}">
                                                <input type="hidden" name="csrf_token"
                                                       value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-primary btn-lg">Update Project</button>
                                            </div>
                                          </div>

                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <a class="scroll-to-top rounded" href="#page-top">
                        <i class="fas fa-angle-up"></i>
                    </a>

                {% include 'common/footer.html' %}
                <script>
                    $(document).ready(function () {
                        // enable tooltip
                        $(function () {
                            $('[data-toggle="tooltip"]').tooltip()
                        })
                    })
                </script>
                    <script>

                        const selectElement = document.getElementById("software_stack_ids");
                        const countDiv = document.getElementById("numberOfSelectedStacks");

                        function updateSelectedCount() {
                            const selectedCount = selectElement.selectedOptions.length;
                            countDiv.innerHTML = `You have selected: <strong>${selectedCount}</strong> Stacks for this profile. (Use <kbd>Command+Click</kbd> or <kbd>Windows+Click</kbd> to select/unselect stacks)`;
                        }

                        const bootstrapTagInputBoxDeniedUsers = UseBootstrapTag(document.getElementById('denied_users'));
                        const bootstrapTagInputBoxAllowedUsers = UseBootstrapTag(document.getElementById('allowed_users'));
                         const bootstrapTagInputBoxDeniedGroups = UseBootstrapTag(document.getElementById('denied_groups'));
                        const bootstrapTagInputBoxAllowedGroups = UseBootstrapTag(document.getElementById('allowed_groups'));
                        document.getElementById('add_group_btn').addEventListener('click', function () {
                          const select = document.getElementById('group_select');
                          const selectedGroup = select.value.trim();
                           bootstrapTagInputBoxAllowedGroups.addValue(selectedGroup);
                    
                        });

                        document.getElementById('add_user_btn').addEventListener('click', function () {
                          const select = document.getElementById('user_select');
                          const selectedUser = select.value.trim();

                          if (selectedUser === '*') {
                            // Clear all tags first
                            const existingTags = bootstrapTagInputBoxAllowedUsers.getValues();
                            if (existingTags.length > 0) {
                              bootstrapTagInputBoxAllowedUsers.removeValue(existingTags);
                            }
                            // Add only '*'
                            bootstrapTagInputBoxAllowedUsers.addValue('*');
                          } else {
                            // If '*' is already present, remove it before adding others
                            const existingTags = bootstrapTagInputBoxAllowedUsers.getValues();
                            if (existingTags.includes('*')) {
                              bootstrapTagInputBoxAllowedUsers.removeValue('*');
                            }
                            // Add the selected user
                            bootstrapTagInputBoxAllowedUsers.addValue(selectedUser);
                          }
                        });
                        updateSelectedCount();
                        selectElement.addEventListener("change", updateSelectedCount);

                       const selectTargetNodeElement = document.getElementById("target_nodes_software_stack_ids");
                        const countTargetNodeDiv = document.getElementById("numberOfSelectedTargetNodeStacks");

                        function updateSelectedTargetNodeStackCount() {
                            const selectedCount = selectTargetNodeElement.selectedOptions.length;
                            countTargetNodeDiv.innerHTML = `You have selected: <strong>${selectedCount}</strong> Target Node Software Stacks for this profile. (Use <kbd>Command+Click</kbd> or <kbd>Windows+Click</kbd> to select/unselect stacks)`;
                        }

                        updateSelectedTargetNodeStackCount();
                        selectTargetNodeElement.addEventListener("change", updateSelectedTargetNodeStackCount);

                        const selectApplicationProfileElement = document.getElementById("application_profile_ids");
                        const countApplicationProfileDiv = document.getElementById("numberOfSelectedApplicationProfiles");

                        function updateSelectedApplicationProfileCount() {
                            const selectedCount = selectApplicationProfileElement.selectedOptions.length;
                            countApplicationProfileDiv.innerHTML = `You have selected: <strong>${selectedCount}</strong> Applications for this profile. (Use <kbd>Command+Click</kbd> or <kbd>Windows+Click</kbd> to select/unselect stacks)`;
                        }

                        updateSelectedApplicationProfileCount();
                        selectApplicationProfileElement.addEventListener("change", updateSelectedApplicationProfileCount);
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
